# Best practices

## Payment Token <a href="#title-text" id="title-text"></a>

The use of the _payment token_ has the following two objectives:

1. defining a payment session temporally;
2. having a identifier generated by the pagoPA platform that permits the _end to end_ identification of a payment session.

The default value for the duration of the _payment token_ is a common configuration at the level of the entire pagoPA platform and cannot be higher than 30 minutes. This parameter can be overwritten by the PSP, with a value lower than 30 minutes, in the _expireTime_ field entered in the _request_ of the [activatePaymentNotice](../../appendices/primitive.md#activatepaymentnotice), and the value must be expressed in milliseconds.

It is essential for each PSP to identify the best expiration value of the token with respect to the type of channel the user uses to pay the notice.

The default value of the duration of the _payment token_ can be redefined based on the monitoring results. The update is communicated by publishing a minor version of this document.

The _payment token_ is provided in _response_ by the pagoPA platform to an [activatePaymentNotice](../../appendices/primitive.md#activatepaymentnotice), and must be inserted by the PSP in the _request_ to the [sendPaymentOutcome](../../appendices/primitive.md#sendpaymentoutcome) and take on the meaning of _identificativoUnivocoRiscossione_ in the reporting flows.

For a correct management of every payment session for every [activatePaymentNotice](../../appendices/primitive.md#activatepaymentnotice), a [sendPaymentOutcome](../../appendices/primitive.md#sendpaymentoutcome) must always follow, both in an OK and in a KO case, in real time with respect to the user’s actions at the touch point of the PSP. This is essential for ensuring a good service quality along the entire chain.

After receiving a response from the Node, the [sendPaymentOutcome](../../appendices/primitive.md#sendpaymentoutcome) must not be invoked again, to take care of the cases in which a response is not received, [#title-text-2](best-practice.md#title-text-2 "mention") must be used.

## sendPaymentOutcome after the expiration of the Payment Token <a href="#title-text" id="title-text"></a>

Only in the case of technical exceptions, the [sendPaymentOutcome](../../appendices/primitive.md#sendpaymentoutcome) is not received from the platform simultaneously with the payment, and therefore if the _payment token_ is sent after expiration, it is possible that the cases identified by the following responses supplied by the pagoPA platform apply

| Platform response| Meaning|
|----------|----------|
| **OK**| The payment outcome notification took place before the expiration of the token.|
| **PPT_TOKEN_SCADUTO**| The payment outcome notification took place after the expiration of the token and the platform does not recognize simultaneous payments.|
| **PPT_TOKEN_SCADUTO_KO**| The notification with the KO outcome of the payment took place after expiration of the token, in that case the Node does not check the status of the debt position.|
| **PPT_PAGAMENTO_DUPLICATO**| The payment outcome notification took place after the expiration of the token and the platform detects another payment for the same position.|

As concerns the **OK** case, no corrective action is necessary.

As concerns the **PPT\_PAGAMENTO\_DUPLICATO** case, the correct action to be done on the PSP side is to return the amount to the user. It is not possible to return the amount, the payment must be reported to the creditor with _code 9_, if the payment process was managed in [stand-in.md](../../implementary-specifications-for-the-SPC-payment-node/general-operation/stand-in.md "mention") mode, _code 8_ must be used.

In the case of **PPT\_TOKEN\_SCADUTO** and **PPT\_TOKEN\_SCADUTO\_KO**, the corrective action to be taken by the PSP is to manage the flow in a temporary manner, in compliance with the duration of the _payment token_.

## Idempotency key <a href="#title-text" id="title-text"></a>

The _idempotency key_  can be generated by the PSP for the calls:

* [activatePaymentNotice](../../appendices/primitive.md#activatepaymentnotice)
* [sendPaymentOutcome](../../appendices/primitive.md#sendpaymentoutcome) 

The purpose of the _idempotency key_ is to make it possible to invoke a call multiple times without any _side effect_ regarding the status of the payment. It is **mandatory** to insert the _idempotency key_ in the _requests_ of the calls that manage it, and the purpose of this instrument is limited to cases in which a response was not received, for any reason, from an idempotency call.

The concept of managing the payment session must not be associated with the _idempotency key_ for any reason which must in fact take place through the correct use of the _payment token._

If a PSP, for example, does not receive the _response_ to the activation of the payment, it can repeat the same call, making sure to use the same idempotency key in order to obtain the data that was intended for them during the first call. If the same idempotency key is not used, the _response_ will instead be “payment in progress” and it will not be possible to proceed with the payment.

The rule for generating the _idempotency key_  is _\<CF\_PSP> + "\_" + \<RANDOM STRING>_.

The duration of the _idempotency key_  is set by the pagoPA platform based on a configuration common to all the PSPs. In the case of the [activatePaymentNotice](../../appendices/primitive.md#activatepaymentnotice) the maximum duration may not exceed that of the payment token.\_

In the case of [activatePaymentNotice](../../appendices/primitive.md#activatepaymentnotice) the _idempotency key_  must be invalidated, not only after the expiration of the key, but also when receiving an outcome for the _payment token_ generated during the activation.

Once the _idempotency key_  has expired, it can be reused.

The platform checks that the _idempotency key_  is used correctly, and in case of an error the fault code _PPT\_ERRORE\_IDEMPOTENZA_ is returned, and the input parameters are checked according to the following table.

| Idempotency key| Other parameters| Action|
|----------|----------|----------|
| Can be associated with an _original_ request| Equal to an _original_ request| No side effects + _original_ response|
| Can be associated with an _original_ request| Different than an _original_ request| KO: improper use of the idempotency key|
| Cannot be associated with an original request| Indifferent| <p>It is, for all purposes, a new request<br></p>|

